{"version":3,"sources":["../../src/lib/_test-helpers.js"],"names":["getModel","options","db","DB","addModel","JsonModel","name","sharedSetup","getPromise","fn","promise","testModels","count","columns","total","type","migrations","init","up","model","queue","expect","toBeTruthy","set","id","byType","preprocessor","event","Error","reducer","get","c","deriver","ignorer","store","result","currentCount","desc","Object","keys","withDBs","EQ","events","ret","Promise","all","close","withESDB","models","eSDB","ESDB","out"],"mappings":"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","sourcesContent":["import DB from '../DB'\nimport ESDB from '../EventSourcingDB'\nimport EQ from '../EventQueue'\nimport JsonModel from '../JsonModel'\n\nexport {DB, JsonModel}\n\nexport const getModel = options => {\n\tconst db = new DB()\n\treturn db.addModel(JsonModel, {name: 'testing', ...options})\n}\n\nexport const sharedSetup = getPromise => fn => {\n\tlet promise\n\treturn async () => {\n\t\tif (!promise) {\n\t\t\tpromise = getPromise()\n\t\t}\n\t\treturn fn(await promise)\n\t}\n}\n\nexport const testModels = {\n\tcount: {\n\t\t// shortName: 'c',\n\t\tcolumns: {\n\t\t\ttotal: {type: 'INTEGER'},\n\t\t},\n\t\tmigrations: {\n\t\t\tinit: {\n\t\t\t\tup({db, model, queue}) {\n\t\t\t\t\texpect(db).toBeTruthy()\n\t\t\t\t\texpect(queue).toBeTruthy()\n\t\t\t\t\treturn model.set({id: 'count', total: 0, byType: {}})\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tpreprocessor: async ({event}) => {\n\t\t\tif (event.type === 'error_pre') throw new Error('pre error for you')\n\t\t},\n\t\treducer: async (model, {type}) => {\n\t\t\tif (type === 'error_reduce') throw new Error('error for you')\n\t\t\tif (!model.get) return false\n\t\t\tconst c = (await model.get('count')) || {\n\t\t\t\tid: 'count',\n\t\t\t\ttotal: 0,\n\t\t\t\tbyType: {},\n\t\t\t}\n\t\t\tc.total++\n\t\t\tc.byType[type] = (c.byType[type] || 0) + 1\n\t\t\treturn {\n\t\t\t\tset: [c],\n\t\t\t\t// audit: '',\n\t\t\t}\n\t\t},\n\t\tderiver: async ({event}) => {\n\t\t\tif (event.type === 'error_derive') throw new Error('post error for you')\n\t\t},\n\t},\n\tignorer: {\n\t\treducer: (model = null) => model,\n\t},\n\tderiver: {\n\t\tderiver: async ({model, store, result, event}) => {\n\t\t\tif (result !== event.result[model.name]) {\n\t\t\t\tthrow new Error('Expecting event.result as separate input')\n\t\t\t}\n\t\t\tif (event.result.count) {\n\t\t\t\tconst currentCount = await store.count.get('count')\n\t\t\t\tawait model.set({\n\t\t\t\t\tid: 'descCount',\n\t\t\t\t\tdesc: `Total: ${currentCount.total}, seen types: ${Object.keys(\n\t\t\t\t\t\tcurrentCount.byType\n\t\t\t\t\t)}`,\n\t\t\t\t})\n\t\t\t}\n\t\t},\n\t},\n}\nconst withDBs = async fn => {\n\tconst db = new DB({name: 'D'})\n\tconst queue = new EQ({\n\t\tdb: new DB({name: 'Q'}),\n\t\tcolumns: {events: {type: 'JSON'}},\n\t})\n\tconst ret = await fn(db, queue)\n\tawait Promise.all([db.close(), queue.db.close()])\n\treturn ret\n}\nexport const withESDB = (fn, models = testModels) =>\n\twithDBs(async (db, queue) => {\n\t\tconst eSDB = new ESDB({queue, models, name: 'E'})\n\t\tconst out = await fn(eSDB, queue)\n\t\tawait eSDB.close()\n\t\treturn out\n\t})\n"],"file":"_test-helpers.js"}